I have a python client application that calls (http) a python Flask api.
Both of these applications are logging to Azure Application insights using the `opencensus` libraries.
I want to do the logging in a fashion so that I can correlate the logs in ApplicationInsights end to end.

## Python client app

For example, when the client app initiates an HTTP GET call to the Flask API, it generates an `http request` dependency log entry in ApplicationInsights.

The app also logs individual entries about the http request and http response into the `trace` table.

## Flask API

I am logging the incoming HTTP request in the Flask API using request decorator, and also logging the HTTP response using a request decorator.
Also the actual method ( that the Flask routing invokes ) has its own logging.

**Note** These are logs go into `trace` table.

## Expectation

I am trying to get the logs generated from the Flask API have a correlation with the log generated from the client application.

## Current behaviour

### Logs of Python client app

- The logs in the `dependency` table have a `operation_Id` - All good!
[![enter image description here][1]][1]

- The logs in the `trace` table have the same `operation_Id` and `operation_ParentId` as above - All good!
[![enter image description here][2]][2]

### Logs of Flask api

- The logs in the `request` table have the same `operation_Id` as above - All good!
[![enter image description here][3]][3]

- The logs in the `trace` table generated by the before_request, after_request decorators - The `operation_Id` and `operation_ParentId` are blank. - **Problematic**!
- The logs in the `trace` table generated by the logging statements inside the `route/methods` - The `operation_Id` and `operation_ParentId` are blank. - **Problematic**!

[![enter image description here][4]][4]
## Help please

I can see that `Traceparent` http header is coming in as part of the http request in the **Flask API**, but looks like logging is ignoring this.
How do I get the logging statements to use the `Traceparent` data so that `operation_Id` and `operation_ParentId` show up correctly in the `traces` table for the **Flask API**?

### Flask API Code

```Python
import flask
from flask import request, jsonify
import logging
import json
import requests
from opencensus.ext.azure.log_exporter import AzureLogHandler,AzureEventHandler
from opencensus.ext.flask.flask_middleware import FlaskMiddleware
from opencensus.ext.azure.trace_exporter import AzureExporter
from opencensus.trace.samplers import ProbabilitySampler, AlwaysOnSampler
from opencensus.trace.tracer import Tracer
from opencensus.trace import config_integration
import os

logger = logging.getLogger()

class MyJSONEncoder(flask.json.JSONEncoder):
    
    def default(self, obj):
        if isinstance(obj, decimal.Decimal):
            # Convert decimal instances to strings.
            return str(obj)
        if isinstance(obj, datetime.datetime):
            return obj.strftime(strftime_iso_regular_format_str)
        return super(MyJSONEncoder, self).default(obj)

# Initialize logging with Azure Application Insights
class CustomDimensionsFilter(logging.Filter):
    """Add custom-dimensions like run_id in each log by using filters."""

    def __init__(self, custom_dimensions=None):
        """Initialize CustomDimensionsFilter."""
        self.custom_dimensions = custom_dimensions or {}

    def filter(self, record):
        """Add the default custom_dimensions into the current log record."""
        dim = {**self.custom_dimensions, **
               getattr(record, "custom_dimensions", {})}
        record.custom_dimensions = dim
        return True


APPLICATION_INSIGHTS_CONNECTIONSTRING=os.getenv('APPLICATION_INSIGHTS_CONNECTIONSTRING')
modulename='FlaskAPI'
APPLICATION_NAME='FlaskAPI'
ENVIRONMENT='Development'

def callback_function(envelope):
    envelope.tags['ai.cloud.role'] = APPLICATION_NAME
    return True

logger = logging.getLogger(__name__)
log_handler = AzureLogHandler(
    connection_string=APPLICATION_INSIGHTS_CONNECTIONSTRING)

log_handler.addFilter(CustomDimensionsFilter(
            {
                'ApplicationName': APPLICATION_NAME,
                'Environment': ENVIRONMENT
            }))

log_handler.add_telemetry_processor(callback_function)
logger.addHandler(log_handler)

azureExporter = AzureExporter(
    connection_string=APPLICATION_INSIGHTS_CONNECTIONSTRING)
azureExporter.add_telemetry_processor(callback_function)

tracer = Tracer(exporter=azureExporter, sampler=AlwaysOnSampler())

app = flask.Flask("app")
app.json_encoder = MyJSONEncoder
app.config["DEBUG"] = True

middleware = FlaskMiddleware(
    app,
    exporter=azureExporter,
    sampler=ProbabilitySampler(rate=1.0),
)

config_integration.trace_integrations(['logging', 'requests'])

def getJsonFromRequestBody(request):
    isContentTypeJson = request.headers.get('Content-Type') == 'application/json'
    doesHaveBodyJson = False
    if isContentTypeJson:
        try:
            doesHaveBodyJson = request.get_json() != None
        except:
            doesHaveBodyJson = False
    if doesHaveBodyJson == True:
        return json.dumps(request.get_json())
    else:
        return None

def get_properties_for_customDimensions_from_request(request):
    values = ''
    

    if len(request.values) == 0:
        values += '(None)'
    for key in request.values:
        values += key + ': ' + request.values[key] + ', '
    properties = {'custom_dimensions':
                  {
                      'request_method': request.method,
                      'request_url': request.url,
                      'values': values,
                      'body': getJsonFromRequestBody(request)
                  }}
    return properties

def get_properties_for_customDimensions_from_response(request,response):
    request_properties = request_properties = get_properties_for_customDimensions_from_request(request)
    request_customDimensions = request_properties.get('custom_dimensions')
    
    response_properties = {'custom_dimensions':
        {
        **request_customDimensions,
        'response_status':response.status,
        'response_body':response.data.decode('utf-8')
        }
    }
    return response_properties

# Useful debugging interceptor to log all values posted to the endpoint
@app.before_request
def before():
    properties = get_properties_for_customDimensions_from_request(request)
    logger.warning("request {} {}".format(
        request.method, request.url), extra=properties)

# Useful debugging interceptor to log all endpoint responses
@app.after_request
def after(response):
    response_properties = get_properties_for_customDimensions_from_response(request,response)
    logger.warning("response: {}".format(
        response.status
    ),extra=response_properties)
    return response

@app.route('/api/{}/status'.format("v1"), methods=['GET'])
def health_check():
    message = "Health ok!"
    logger.info(message)
    return message

if __name__ == '__main__':
    app.run()
```

### References used

- [Microsoft's guidance on Application Insights Log Correlation](https://docs.microsoft.com/en-us/azure/azure-monitor/app/correlation)
- [My code repository where I have tested and reproduced the problem](https://github.com/miniGweek/python-flask-applicationinsights-logging-example)


  [1]: https://i.stack.imgur.com/qPgaj.png
  [2]: https://i.stack.imgur.com/1801P.png
  [3]: https://i.stack.imgur.com/mhvh4.png
  [4]: https://i.stack.imgur.com/WTpzI.png